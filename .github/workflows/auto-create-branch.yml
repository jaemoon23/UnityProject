# .github/workflows/auto-create-branch.yml
name: Auto Create Branch on Issue Assignment

on:
  issues:
    types: [assigned]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  create-branch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Create branch for assigned issue
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          ASSIGNEE="${{ github.event.assignee.login }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          
          # Issue ë¼ë²¨ì—ì„œ ë¸Œëœì¹˜ íƒ€ì… ê²°ì •
          LABELS='${{ toJson(github.event.issue.labels.*.name) }}'
          
          # ë¼ë²¨ ê¸°ë°˜ íƒ€ì… ë§¤í•‘
          if echo "$LABELS" | grep -q "bug"; then
            BRANCH_TYPE="bugfix"
          elif echo "$LABELS" | grep -q "enhancement"; then
            BRANCH_TYPE="feature"
          elif echo "$LABELS" | grep -q "documentation"; then
            BRANCH_TYPE="docs"
          elif echo "$LABELS" | grep -q "hotfix"; then
            BRANCH_TYPE="hotfix"
          elif echo "$LABELS" | grep -q "error"; then
            BRANCH_TYPE="error-fix"
          elif echo "$LABELS" | grep -q "refactor"; then
            BRANCH_TYPE="refactor"
          elif echo "$LABELS" | grep -q "test"; then
            BRANCH_TYPE="test"
          else
            BRANCH_TYPE="feature"
          fi
          
          # Issue ì œëª©ì—ì„œ [Feature], [Bug] ë“± ì œê±°
          CLEAN_TITLE=$(echo "$ISSUE_TITLE" | sed 's/^\[.*\][[:space:]]*//')
          
          # ì´ìŠˆ ì œëª©ì„ ë¸Œëœì¹˜ëª…ìœ¼ë¡œ ë³€í™˜ (ì†Œë¬¸ì, í•˜ì´í”ˆ, ê¸¸ì´ ì œí•œ ì—†ìŒ)
          DESCRIPTION=$(echo "$CLEAN_TITLE" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | sed 's/[^a-z0-9-]//g' | sed 's/-$//')
          
          BRANCH_NAME="${BRANCH_TYPE}/${ISSUE_NUMBER}-${DESCRIPTION}"
          
          echo "Creating branch: $BRANCH_NAME"
          
          # ë¸Œëœì¹˜ ìƒì„±
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # mainì—ì„œ ìµœì‹  ë³€ê²½ì‚¬í•­ ê°€ì ¸ì˜¤ê¸°
          git checkout main
          git pull origin main
          
          # ë¸Œëœì¹˜ê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists"
          else
            # ìƒˆ ë¸Œëœì¹˜ ìƒì„± ë° í‘¸ì‹œ
            git checkout -b "$BRANCH_NAME"
            git push origin "$BRANCH_NAME"
            echo "Branch $BRANCH_NAME created successfully"
          fi
          
          # Issueì— ì½”ë©˜íŠ¸ ì¶”ê°€
          gh issue comment $ISSUE_NUMBER --body "$(cat <<EOF
          âœ… **Branchê°€ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!**

          \`\`\`
          $BRANCH_NAME
          \`\`\`

          ğŸ“‹ **ë‹¤ìŒ ë‹¨ê³„:**
          1. ë¡œì»¬ì—ì„œ ë¸Œëœì¹˜ë¥¼ ì²´í¬ì•„ì›ƒí•˜ì„¸ìš”:
             \`\`\`bash
             git fetch origin
             git checkout $BRANCH_NAME
             \`\`\`

          2. ì‘ì—…ì„ ì™„ë£Œí•˜ê³  ì»¤ë°‹í•˜ì„¸ìš”

          3. PR ìƒì„± ì‹œ ì´ Issueë¥¼ ìë™ìœ¼ë¡œ ë‹«ìœ¼ë ¤ë©´ PR ì„¤ëª…ì— ë‹¤ìŒì„ í¬í•¨í•˜ì„¸ìš”:
             \`Closes #$ISSUE_NUMBER\`

          ğŸ¯ **ë‹´ë‹¹ì:** @$ASSIGNEE
          EOF
          )"
        env:
          GH_TOKEN: ${{ github.token }}