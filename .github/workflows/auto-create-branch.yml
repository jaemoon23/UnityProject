name: Auto Create Branch on Issue Assignment

on:
  issues:
    types: [opened, assigned]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  create-branch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0
      
      - name: Create branch for assigned issue
        run: |
          ISSUE_NUMBER=${{ github.event.issue.number }}
          ASSIGNEE="${{ github.event.issue.assignee.login }}"
          ISSUE_TITLE="${{ github.event.issue.title }}"
          LABELS='${{ toJson(github.event.issue.labels.*.name) }}'
          
          if [ -z "$ASSIGNEE" ] || [ "$ASSIGNEE" = "null" ]; then
            echo "No assignee for this issue. Skipping branch creation."
            exit 0
          fi
          
          if echo "$LABELS" | grep -qE "feature-request|meeting"; then
            echo "This issue type does not create branches"
            gh issue comment $ISSUE_NUMBER --body "â„¹ï¸ **ì´ IssueëŠ” ë¸Œëœì¹˜ë¥¼ ìë™ ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.**"
            exit 0
          fi
          
          if echo "$LABELS" | grep -q "bug\|fix"; then
            BRANCH_TYPE="fix"
          elif echo "$LABELS" | grep -q "enhancement\|feature"; then
            BRANCH_TYPE="feature"
          elif echo "$LABELS" | grep -q "documentation\|docs"; then
            BRANCH_TYPE="docs"
          elif echo "$LABELS" | grep -q "refactor"; then
            BRANCH_TYPE="refactor"
          elif echo "$LABELS" | grep -q "data\|csvs"; then
            BRANCH_TYPE="csvs"
          else
            BRANCH_TYPE="feature"
          fi
          
          CLEAN_TITLE=$(echo "$ISSUE_TITLE" | sed 's/^\[.*\][[:space:]]*//')
          DESCRIPTION=$(echo "$CLEAN_TITLE" | tr '[:upper:]' '[:lower:]' | tr ' ' '-' | sed 's/[^a-z0-9-]//g' | sed 's/-$//' | sed 's/^-//')
          
          BRANCH_NAME="${BRANCH_TYPE}/${ISSUE_NUMBER}-${DESCRIPTION}"
          
          echo "Creating branch: $BRANCH_NAME"
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git checkout main
          git pull origin main
          
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch $BRANCH_NAME already exists"
            gh issue comment $ISSUE_NUMBER --body "âš ï¸ **Branchê°€ ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤:** \`$BRANCH_NAME\`"
          else
            git checkout -b "$BRANCH_NAME"
            git push origin "$BRANCH_NAME"
            echo "Branch $BRANCH_NAME created successfully"
            
            COMMENT="âœ… **Branchê°€ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!**

\`\`\`
${BRANCH_NAME}
\`\`\`

ğŸ“‹ **ë‹¤ìŒ ë‹¨ê³„:**
1. ë¡œì»¬ì—ì„œ ë¸Œëœì¹˜ë¥¼ ì²´í¬ì•„ì›ƒí•˜ì„¸ìš”:
\`\`\`bash
git fetch origin
git checkout ${BRANCH_NAME}
\`\`\`

2. ì‘ì—…ì„ ì™„ë£Œí•˜ê³  ì»¤ë°‹í•˜ì„¸ìš”

3. PR ìƒì„± ì‹œ ì´ Issueë¥¼ ìë™ìœ¼ë¡œ ë‹«ìœ¼ë ¤ë©´ PR ì„¤ëª…ì— ë‹¤ìŒì„ í¬í•¨í•˜ì„¸ìš”:
\`Closes #${ISSUE_NUMBER}\`

ğŸ¯ **ë‹´ë‹¹ì:** @${ASSIGNEE}

ğŸ’¡ **Tip:** ë¸Œëœì¹˜ëª…ì— Issue ë²ˆí˜¸(#${ISSUE_NUMBER})ê°€ í¬í•¨ë˜ì–´ ìˆì–´ ì¶”ì ì´ ìš©ì´í•©ë‹ˆë‹¤!"
            
            gh issue comment $ISSUE_NUMBER --body "$COMMENT"
          fi
        env:
          GH_TOKEN: ${{ github.token }}
