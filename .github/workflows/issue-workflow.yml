name: Issue Workflow

on:
  issues:
    types: [opened, assigned, reopened]

permissions:
  contents: write
  issues: write

jobs:
  handle-issue:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Handle Issue Event
        uses: actions/github-script@v7
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
          NOTION_DATABASE_ID: ${{ secrets.NOTION_DATABASE_ID }}
        with:
          script: |
            const https = require('https');
            const { execSync } = require('child_process');
            
            console.log('ğŸ” Starting workflow...');
            console.log('ğŸ“‹ Webhook URL exists:', !!process.env.SLACK_WEBHOOK_URL);
            console.log('ğŸ“‹ Webhook URL length:', process.env.SLACK_WEBHOOK_URL?.length || 0);
            
            const issueNumber = context.payload.issue.number;
            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body || 'ë‚´ìš© ì—†ìŒ';
            const issueUrl = context.payload.issue.html_url;
            const action = context.payload.action;
            const labels = context.payload.issue.labels.map(l => l.name);
            const assignees = context.payload.issue.assignees;
            const assignee = assignees.length > 0 ? assignees[0].login : null;
            const milestone = context.payload.issue.milestone?.title || 'ì—†ìŒ';
            
            console.log(`ğŸ“Œ Issue #${issueNumber}: ${issueTitle}`);
            console.log(`ğŸ“Œ Action: ${action}`);
            console.log(`ğŸ“Œ Assignee: ${assignee || 'None'}`);
            
            const userMapping = {
              'leemjmorris': 'U09R6F3CBHN',
              'jaemoon23': 'U09QR380TLH',
              'LeeChaeBin002': 'U09QFND0J20',
              'Kdwio': 'U09LZ9Q6F3J',
              'bunggoo0105': 'U09RL7QCYV7',
              'JangYeJin1207': 'U09QAEF5FEJ'
            };
            
            function callGeminiAPI(prompt) {
              return new Promise((resolve, reject) => {
                console.log('ğŸ¤– Calling Gemini API...');
                const data = JSON.stringify({
                  contents: [{
                    parts: [{ text: prompt }]
                  }]
                });
                
                const options = {
                  hostname: 'generativelanguage.googleapis.com',
                  path: '/v1beta/models/gemini-pro:generateContent?key=' + process.env.GEMINI_API_KEY,
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': data.length
                  }
                };
                
                const req = https.request(options, (res) => {
                  let body = '';
                  res.on('data', (chunk) => body += chunk);
                  res.on('end', () => {
                    try {
                      const response = JSON.parse(body);
                      const text = response.candidates?.[0]?.content?.parts?.[0]?.text || 'ìš”ì•½ ì‹¤íŒ¨';
                      console.log('âœ… Gemini API success');
                      resolve(text);
                    } catch (error) {
                      console.error('âŒ Gemini API parse error:', error);
                      reject(error);
                    }
                  });
                });
                
                req.on('error', (error) => {
                  console.error('âŒ Gemini API request error:', error);
                  reject(error);
                });
                req.write(data);
                req.end();
              });
            }
            
            function sendToSlack(message) {
              return new Promise((resolve, reject) => {
                console.log('ğŸ“¨ Sending to Slack...');
                console.log('ğŸ“¨ Message:', JSON.stringify(message, null, 2));
                
                const data = JSON.stringify(message);
                const url = new URL(process.env.SLACK_WEBHOOK_URL);
                
                console.log('ğŸ“¨ Slack hostname:', url.hostname);
                console.log('ğŸ“¨ Slack path:', url.pathname);
                
                const options = {
                  hostname: url.hostname,
                  path: url.pathname + url.search,
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'Content-Length': data.length
                  }
                };
                
                const req = https.request(options, (res) => {
                  console.log('ğŸ“¨ Slack response status:', res.statusCode);
                  let body = '';
                  res.on('data', (chunk) => body += chunk);
                  res.on('end', () => {
                    console.log('ğŸ“¨ Slack response body:', body);
                    if (res.statusCode === 200) {
                      console.log('âœ… Slack message sent successfully');
                      resolve(body);
                    } else {
                      console.error('âŒ Slack API returned non-200 status');
                      reject(new Error(`Slack returned ${res.statusCode}: ${body}`));
                    }
                  });
                });
                
                req.on('error', (error) => {
                  console.error('âŒ Slack request error:', error);
                  reject(error);
                });
                req.write(data);
                req.end();
              });
            }
            
            function addToNotion(properties) {
              return new Promise((resolve, reject) => {
                console.log('ğŸ“ Adding to Notion...');
                const data = JSON.stringify({
                  parent: { database_id: process.env.NOTION_DATABASE_ID },
                  properties: properties
                });
                
                const options = {
                  hostname: 'api.notion.com',
                  path: '/v1/pages',
                  method: 'POST',
                  headers: {
                    'Authorization': 'Bearer ' + process.env.NOTION_API_TOKEN,
                    'Content-Type': 'application/json',
                    'Notion-Version': '2022-06-28',
                    'Content-Length': data.length
                  }
                };
                
                const req = https.request(options, (res) => {
                  let body = '';
                  res.on('data', (chunk) => body += chunk);
                  res.on('end', () => {
                    if (res.statusCode === 200) {
                      console.log('âœ… Notion page created successfully');
                    } else {
                      console.error('âŒ Notion API error:', res.statusCode, body);
                    }
                    resolve(body);
                  });
                });
                
                req.on('error', (error) => {
                  console.error('âŒ Notion request error:', error);
                  reject(error);
                });
                req.write(data);
                req.end();
              });
            }
            
            try {
              if (action === 'opened') {
                console.log('ğŸ¯ Handling "opened" action');
                
                const summary = await callGeminiAPI(
                  `ë‹¤ìŒ GitHub Issueë¥¼ 3ì¤„ ì´ë‚´ë¡œ ìš”ì•½í•´ì£¼ì„¸ìš”:\nì œëª©: ${issueTitle}\në‚´ìš©: ${issueBody}`
                );
                
                const slackMessage = {
                  text: 'ìƒˆë¡œìš´ Issueê°€ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤',
                  blocks: [
                    {
                      type: 'section',
                      text: {
                        type: 'mrkdwn',
                        text: `:memo: *ìƒˆë¡œìš´ Issue* #${issueNumber}`
                      }
                    },
                    {
                      type: 'section',
                      fields: [
                        { type: 'mrkdwn', text: `*ì œëª©:*\n${issueTitle}` },
                        { type: 'mrkdwn', text: `*Assignee:*\n${assignee || 'ë¯¸ì§€ì •'}` }
                      ]
                    },
                    {
                      type: 'section',
                      text: {
                        type: 'mrkdwn',
                        text: `*AI ìš”ì•½:*\n${summary}`
                      }
                    },
                    {
                      type: 'section',
                      text: {
                        type: 'mrkdwn',
                        text: `<${issueUrl}|:link: Issue ë³´ê¸°>`
                      }
                    }
                  ]
                };
                
                await sendToSlack(slackMessage);
                
                const notionProperties = {
                  'Name': { title: [{ text: { content: issueTitle } }] },
                  'Issue Number': { number: issueNumber },
                  'Status': { select: { name: 'Open' } },
                  'URL': { url: issueUrl },
                  'Assignee': assignee ? { rich_text: [{ text: { content: assignee } }] } : { rich_text: [] }
                };
                
                await addToNotion(notionProperties);
                
                if (assignee) {
                  console.log('ğŸŒ¿ Creating branch...');
                  const branchName = `issue-${issueNumber}`;
                  execSync(`git checkout -b ${branchName}`, { stdio: 'inherit' });
                  execSync(`git push origin ${branchName}`, { stdio: 'inherit' });
                  
                  const branchSlackMessage = {
                    text: 'Branchê°€ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤',
                    blocks: [
                      {
                        type: 'section',
                        text: {
                          type: 'mrkdwn',
                          text: `:white_check_mark: Branch ìƒì„± ì™„ë£Œ\n*Branch:* ${branchName}\n*Issue:* #${issueNumber} ${issueTitle}`
                        }
                      }
                    ]
                  };
                  
                  await sendToSlack(branchSlackMessage);
                }
              }
              
              if (action === 'assigned' && assignee) {
                console.log('ğŸ¯ Handling "assigned" action');
                const branchName = `issue-${issueNumber}`;
                
                try {
                  execSync(`git checkout -b ${branchName}`, { stdio: 'inherit' });
                  execSync(`git push origin ${branchName}`, { stdio: 'inherit' });
                  
                  const slackUserId = userMapping[assignee];
                  const mentionText = slackUserId ? `<@${slackUserId}>` : assignee;
                  
                  const slackMessage = {
                    text: 'Branchê°€ ìë™ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤',
                    blocks: [
                      {
                        type: 'section',
                        text: {
                          type: 'mrkdwn',
                          text: `:white_check_mark: Branch ìƒì„± ì™„ë£Œ\n*Branch:* ${branchName}\n*Assignee:* ${mentionText}\n*Issue:* #${issueNumber} ${issueTitle}\n<${issueUrl}|:link: Issue ë³´ê¸°>`
                        }
                      }
                    ]
                  };
                  
                  await sendToSlack(slackMessage);
                } catch (error) {
                  console.log('âš ï¸ Branch already exists or creation failed:', error.message);
                }
              }
              
              if (action === 'reopened') {
                console.log('ğŸ¯ Handling "reopened" action');
                const slackMessage = {
                  text: 'Issueê°€ ë‹¤ì‹œ ì—´ë ¸ìŠµë‹ˆë‹¤',
                  blocks: [
                    {
                      type: 'section',
                      text: {
                        type: 'mrkdwn',
                        text: `:repeat: *Issue ì¬ì˜¤í”ˆ* #${issueNumber}\n*ì œëª©:* ${issueTitle}\n*Assignee:* ${assignee || 'ë¯¸ì§€ì •'}\n<${issueUrl}|:link: Issue ë³´ê¸°>`
                      }
                    }
                  ]
                };
                
                await sendToSlack(slackMessage);
              }
              
              const hasImportantLabel = labels.some(label => 
                ['urgent', 'critical', 'bug', 'hotfix'].includes(label.toLowerCase())
              );
              
              if (hasImportantLabel && assignee) {
                console.log('ğŸš¨ Important label detected');
                const slackUserId = userMapping[assignee];
                const mentionText = slackUserId ? `<@${slackUserId}>` : assignee;
                
                const slackMessage = {
                  text: 'ì¤‘ìš” ë¼ë²¨ì´ ìˆëŠ” Issueì…ë‹ˆë‹¤',
                  blocks: [
                    {
                      type: 'section',
                      text: {
                        type: 'mrkdwn',
                        text: `:rotating_light: *ì¤‘ìš” Issue ì•Œë¦¼*\n${mentionText}\n*Issue:* #${issueNumber} ${issueTitle}\n*Labels:* ${labels.join(', ')}\n<${issueUrl}|:link: Issue ë³´ê¸°>`
                      }
                    }
                  ]
                };
                
                await sendToSlack(slackMessage);
              }
              
              console.log('âœ… Workflow completed successfully');
              
            } catch (error) {
              console.error('âŒ Workflow error:', error);
              console.error('âŒ Error stack:', error.stack);
              core.setFailed(error.message);
            }
