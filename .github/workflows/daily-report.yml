name: Daily Report

on:
  schedule:
    - cron: '0 9 * * 1-5'
  workflow_dispatch:

permissions:
  contents: read
  issues: read
  pull-requests: read

jobs:
  generate-daily-report:
    runs-on: ubuntu-latest
    steps:
      - name: Generate Daily Report
        uses: actions/github-script@v7
        env:
          NOTION_API_TOKEN: ${{ secrets.NOTION_API_TOKEN }}
          NOTION_REPORT_PAGE_ID: ${{ secrets.NOTION_REPORT_PAGE_ID }}
        with:
          script: |
            const https = require('https');
            
            // LMJ : Get today's date in KST (UTC+9)
            const now = new Date();
            const kstOffset = 9 * 60 * 60 * 1000;
            const kstDate = new Date(now.getTime() + kstOffset);
            const today = kstDate.toISOString().split('T')[0];
            const yesterday = new Date(kstDate.getTime() - 24 * 60 * 60 * 1000).toISOString().split('T')[0];
            
            const dateStr = kstDate.toLocaleDateString('ko-KR', { 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric',
              weekday: 'long'
            });
            
            // LMJ : GitHub username to real name mapping
            const userNames = {
              'leemjmorris': 'ì´ëª…ì§„',
              'jaemoon23': 'ê¹€ì¬ë¬¸',
              'LeeChaeBin002': 'ì´ì±„ë¹ˆ',
              'Kdwio': 'ê¹€ë„ìœ¤',
              'bigwaterplz': 'ì˜¤ë¯¼ì¤€',
              'kimjiw8698-crypto': 'ê¹€ì§€ì›'
            };
            
            async function addToNotion(content) {
              const token = process.env.NOTION_API_TOKEN;
              const parentPageId = process.env.NOTION_REPORT_PAGE_ID;
              
              return new Promise((resolve, reject) => {
                const data = JSON.stringify({
                  parent: { page_id: parentPageId },
                  icon: { emoji: 'ğŸ“Š' },
                  properties: {
                    title: {
                      title: [{ text: { content: `${dateStr} ê°œë°œ í˜„í™©` } }]
                    }
                  },
                  children: content
                });
                
                const req = https.request({
                  hostname: 'api.notion.com',
                  path: '/v1/pages',
                  method: 'POST',
                  headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json',
                    'Notion-Version': '2022-06-28'
                  }
                }, (res) => {
                  let body = '';
                  res.on('data', d => body += d);
                  res.on('end', () => resolve(JSON.parse(body)));
                });
                req.on('error', reject);
                req.write(data);
                req.end();
              });
            }
            
            try {
              console.log(`Generating daily report for ${dateStr}...`);
              
              // LMJ : Get issues created in last 24 hours
              const issuesCreated = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                since: yesterday,
                state: 'all',
                per_page: 100
              });
              
              const newIssues = issuesCreated.data.filter(issue => 
                !issue.pull_request && 
                new Date(issue.created_at) >= new Date(yesterday)
              );
              
              // LMJ : Get issues closed in last 24 hours
              const closedIssues = issuesCreated.data.filter(issue => 
                !issue.pull_request && 
                issue.state === 'closed' &&
                issue.closed_at &&
                new Date(issue.closed_at) >= new Date(yesterday)
              );
              
              // LMJ : Get PRs created in last 24 hours
              const prsCreated = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'all',
                sort: 'created',
                direction: 'desc',
                per_page: 100
              });
              
              const newPRs = prsCreated.data.filter(pr => 
                new Date(pr.created_at) >= new Date(yesterday)
              );
              
              // LMJ : Get PRs merged in last 24 hours
              const mergedPRs = prsCreated.data.filter(pr => 
                pr.merged_at &&
                new Date(pr.merged_at) >= new Date(yesterday)
              );
              
              // LMJ : Get active issues (in progress)
              const activeIssues = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                state: 'open',
                per_page: 100
              });
              
              const inProgressIssues = activeIssues.data.filter(issue => 
                !issue.pull_request &&
                issue.assignees.length > 0
              );
              
              // LMJ : Calculate statistics by user
              const userStats = {};
              
              for (const issue of inProgressIssues) {
                for (const assignee of issue.assignees) {
                  const userName = userNames[assignee.login] || assignee.login;
                  if (!userStats[userName]) {
                    userStats[userName] = {
                      inProgress: 0,
                      completed: 0,
                      prs: 0
                    };
                  }
                  userStats[userName].inProgress++;
                }
              }
              
              for (const issue of closedIssues) {
                for (const assignee of issue.assignees) {
                  const userName = userNames[assignee.login] || assignee.login;
                  if (!userStats[userName]) {
                    userStats[userName] = {
                      inProgress: 0,
                      completed: 0,
                      prs: 0
                    };
                  }
                  userStats[userName].completed++;
                }
              }
              
              for (const pr of mergedPRs) {
                const userName = userNames[pr.user.login] || pr.user.login;
                if (!userStats[userName]) {
                  userStats[userName] = {
                    inProgress: 0,
                    completed: 0,
                    prs: 0
                  };
                }
                userStats[userName].prs++;
              }
              
              // LMJ : Create Notion blocks
              const blocks = [
                {
                  object: 'block',
                  type: 'heading_2',
                  heading_2: {
                    rich_text: [{ text: { content: 'ğŸ“Š ì¼ì¼ ê°œë°œ í˜„í™©' } }]
                  }
                },
                {
                  object: 'block',
                  type: 'divider',
                  divider: {}
                },
                {
                  object: 'block',
                  type: 'heading_3',
                  heading_3: {
                    rich_text: [{ text: { content: 'ğŸ“ˆ í†µê³„ ìš”ì•½' } }]
                  }
                },
                {
                  object: 'block',
                  type: 'bulleted_list_item',
                  bulleted_list_item: {
                    rich_text: [
                      { text: { content: 'ìƒì„±ëœ Issue: ' } },
                      { text: { content: `${newIssues.length}ê°œ`, annotations: { bold: true } } }
                    ]
                  }
                },
                {
                  object: 'block',
                  type: 'bulleted_list_item',
                  bulleted_list_item: {
                    rich_text: [
                      { text: { content: 'ì™„ë£Œëœ Issue: ' } },
                      { text: { content: `${closedIssues.length}ê°œ`, annotations: { bold: true } } }
                    ]
                  }
                },
                {
                  object: 'block',
                  type: 'bulleted_list_item',
                  bulleted_list_item: {
                    rich_text: [
                      { text: { content: 'ìƒì„±ëœ PR: ' } },
                      { text: { content: `${newPRs.length}ê°œ`, annotations: { bold: true } } }
                    ]
                  }
                },
                {
                  object: 'block',
                  type: 'bulleted_list_item',
                  bulleted_list_item: {
                    rich_text: [
                      { text: { content: 'ë¨¸ì§€ëœ PR: ' } },
                      { text: { content: `${mergedPRs.length}ê°œ`, annotations: { bold: true } } }
                    ]
                  }
                },
                {
                  object: 'block',
                  type: 'bulleted_list_item',
                  bulleted_list_item: {
                    rich_text: [
                      { text: { content: 'ì§„í–‰ ì¤‘ì¸ Issue: ' } },
                      { text: { content: `${inProgressIssues.length}ê°œ`, annotations: { bold: true } } }
                    ]
                  }
                }
              ];
              
              // LMJ : Add user statistics
              if (Object.keys(userStats).length > 0) {
                blocks.push(
                  {
                    object: 'block',
                    type: 'divider',
                    divider: {}
                  },
                  {
                    object: 'block',
                    type: 'heading_3',
                    heading_3: {
                      rich_text: [{ text: { content: 'ğŸ‘¥ íŒ€ì›ë³„ í˜„í™©' } }]
                    }
                  }
                );
                
                for (const [userName, stats] of Object.entries(userStats)) {
                  blocks.push({
                    object: 'block',
                    type: 'bulleted_list_item',
                    bulleted_list_item: {
                      rich_text: [
                        { text: { content: `${userName}: `, annotations: { bold: true } } },
                        { text: { content: `ì§„í–‰ì¤‘ ${stats.inProgress}ê°œ ` } },
                        { text: { content: '/ ', annotations: { color: 'gray' } } },
                        { text: { content: `ì™„ë£Œ ${stats.completed}ê°œ ` } },
                        { text: { content: '/ ', annotations: { color: 'gray' } } },
                        { text: { content: `PR ${stats.prs}ê°œ` } }
                      ]
                    }
                  });
                }
              }
              
              // LMJ : Add new issues section
              if (newIssues.length > 0) {
                blocks.push(
                  {
                    object: 'block',
                    type: 'divider',
                    divider: {}
                  },
                  {
                    object: 'block',
                    type: 'heading_3',
                    heading_3: {
                      rich_text: [{ text: { content: 'ğŸ†• ìƒì„±ëœ Issue' } }]
                    }
                  }
                );
                
                for (const issue of newIssues) {
                  const assigneeNames = issue.assignees.map(a => 
                    userNames[a.login] || a.login
                  ).join(', ') || 'ë¯¸ë°°ì •';
                  
                  blocks.push({
                    object: 'block',
                    type: 'bulleted_list_item',
                    bulleted_list_item: {
                      rich_text: [
                        { 
                          text: { 
                            content: `#${issue.number} `,
                            link: { url: issue.html_url }
                          },
                          annotations: { bold: true }
                        },
                        { text: { content: `${issue.title} ` } },
                        { text: { content: `(ë‹´ë‹¹: ${assigneeNames})`, annotations: { color: 'gray' } } }
                      ]
                    }
                  });
                }
              }
              
              // LMJ : Add closed issues section
              if (closedIssues.length > 0) {
                blocks.push(
                  {
                    object: 'block',
                    type: 'divider',
                    divider: {}
                  },
                  {
                    object: 'block',
                    type: 'heading_3',
                    heading_3: {
                      rich_text: [{ text: { content: 'âœ… ì™„ë£Œëœ Issue' } }]
                    }
                  }
                );
                
                for (const issue of closedIssues) {
                  const assigneeNames = issue.assignees.map(a => 
                    userNames[a.login] || a.login
                  ).join(', ') || 'ë¯¸ë°°ì •';
                  
                  blocks.push({
                    object: 'block',
                    type: 'bulleted_list_item',
                    bulleted_list_item: {
                      rich_text: [
                        { 
                          text: { 
                            content: `#${issue.number} `,
                            link: { url: issue.html_url }
                          },
                          annotations: { bold: true, strikethrough: true }
                        },
                        { text: { content: `${issue.title} `, annotations: { strikethrough: true } } },
                        { text: { content: `(ë‹´ë‹¹: ${assigneeNames})`, annotations: { color: 'gray' } } }
                      ]
                    }
                  });
                }
              }
              
              // LMJ : Add merged PRs section
              if (mergedPRs.length > 0) {
                blocks.push(
                  {
                    object: 'block',
                    type: 'divider',
                    divider: {}
                  },
                  {
                    object: 'block',
                    type: 'heading_3',
                    heading_3: {
                      rich_text: [{ text: { content: 'ğŸ”€ ë¨¸ì§€ëœ PR' } }]
                    }
                  }
                );
                
                for (const pr of mergedPRs) {
                  const authorName = userNames[pr.user.login] || pr.user.login;
                  
                  blocks.push({
                    object: 'block',
                    type: 'bulleted_list_item',
                    bulleted_list_item: {
                      rich_text: [
                        { 
                          text: { 
                            content: `#${pr.number} `,
                            link: { url: pr.html_url }
                          },
                          annotations: { bold: true }
                        },
                        { text: { content: `${pr.title} ` } },
                        { text: { content: `(ì‘ì„±ì: ${authorName})`, annotations: { color: 'gray' } } }
                      ]
                    }
                  });
                }
              }
              
              // LMJ : Add in-progress issues section
              if (inProgressIssues.length > 0) {
                blocks.push(
                  {
                    object: 'block',
                    type: 'divider',
                    divider: {}
                  },
                  {
                    object: 'block',
                    type: 'heading_3',
                    heading_3: {
                      rich_text: [{ text: { content: 'ğŸ”„ ì§„í–‰ ì¤‘ì¸ Issue' } }]
                    }
                  }
                );
                
                for (const issue of inProgressIssues.slice(0, 20)) {
                  const assigneeNames = issue.assignees.map(a => 
                    userNames[a.login] || a.login
                  ).join(', ');
                  
                  blocks.push({
                    object: 'block',
                    type: 'bulleted_list_item',
                    bulleted_list_item: {
                      rich_text: [
                        { 
                          text: { 
                            content: `#${issue.number} `,
                            link: { url: issue.html_url }
                          },
                          annotations: { bold: true }
                        },
                        { text: { content: `${issue.title} ` } },
                        { text: { content: `(ë‹´ë‹¹: ${assigneeNames})`, annotations: { color: 'gray' } } }
                      ]
                    }
                  });
                }
                
                if (inProgressIssues.length > 20) {
                  blocks.push({
                    object: 'block',
                    type: 'paragraph',
                    paragraph: {
                      rich_text: [
                        { text: { content: `... ì™¸ ${inProgressIssues.length - 20}ê°œ`, annotations: { italic: true, color: 'gray' } } }
                      ]
                    }
                  });
                }
              }
              
              // LMJ : Add footer
              blocks.push(
                {
                  object: 'block',
                  type: 'divider',
                  divider: {}
                },
                {
                  object: 'block',
                  type: 'paragraph',
                  paragraph: {
                    rich_text: [
                      { text: { content: 'ğŸ¤– ì´ ë¦¬í¬íŠ¸ëŠ” GitHub Actionsì— ì˜í•´ ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.', annotations: { italic: true, color: 'gray' } } }
                    ]
                  }
                }
              );
              
              // LMJ : Add to Notion
              await addToNotion(blocks);
              console.log('âœ… Daily report added to Notion');
              
              console.log('âœ… Daily report generation completed');
              
            } catch (error) {
              console.error('âŒ Error:', error);
              core.setFailed(error.message);
            }
